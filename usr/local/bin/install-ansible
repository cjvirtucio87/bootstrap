#!/bin/bash

ANSIBLE_REPO="${ANSIBLE_REPO:-ppa:ansible/ansible}";
PLATFORM="${DOTFILES_PLATFORM:-ubuntu}";
PYTHON_VER='3.6'
LOG_LEVEL="${LOG_LEVEL:-INFO}";

read -r -d '' INSTALL_USAGE <<'EOF'
install-ansible
[summary]
Command for installing ansible.

[description]
Install the ansible and the required python binaries for the specified $PLATFORM.

Must be run as root.

[usage]
- View this help message:
install-ansible -h

- Execute with a log level of DEBUG:
LOG_LEVEL=debug install-ansible 
EOF

log_debug() {
  if [[ $(echo $LOG_LEVEL | awk '{print tolower($0)}') =~ ^(debug|error)$ ]]; then
    echo "[DEBUG] ${1}";
  fi
}

log_error() {
  if [[ $(echo $LOG_LEVEL | awk '{print tolower($0)}') =~ ^(info|debug|error)$ ]]; then
    echo "[ERROR] ${1}";
  fi
}

log_warn() {
  if [[ $(echo $LOG_LEVEL | awk '{print tolower($0)}') =~ ^(info|warn|debug|error)$ ]]; then
    echo "[WARN] ${1}";
  fi
}

main() {
  while (( "$#" )); do
    case "$1" in
      '-h' | '--help')
        echo "${INSTALL_USAGE}";
        exit 0;
        ;;
      *)
    esac
  done

  case "${PLATFORM}" in
    'ubuntu')
      apt update;
      apt install 'software-properties-common';
      apt-add-repository --yes --update "${ANSIBLE_REPO}";
      apt-get install -y "python${PYTHON_VER}" 'ansible';
      ;;
    *)
      log_debug "unsupported platform, ${PLATFORM}";
      exit 1;
      ;;
  esac

  echo "done"; 
}

main "$@";
