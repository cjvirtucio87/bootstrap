#!/bin/bash

CONFIG_PATH="${HOME}/.stowsh";
CURRENT_DIR=$(dirname $0);
DOTFILES_URL="${DOTFILES_URL:-git@github.com:your_usr_name/dotfiles.git}";
DOTFILES_PLATFORM="${DOTFILES_PLATFORM:-ubuntu}";
LOG_LEVEL="${LOG_LEVEL:-INFO}";
DOTFILES_DEPLOY_DIR="${DOTFILES_DEPLOY_DIR:-/mnt/c/Users/cjv28}";

read -r -d '' STOWSH_USAGE <<'EOF'
stowsh
[summary]
Command for managing your dotfiles.

[description]
This is a command-line tool for managing dotfiles.

Available subcommands:
- install (install your dotfiles)
- git (pass-thru to git on your cloned dotfiles)

[usage]
- View this help message:
stowsh -h

- Execute with a log level of DEBUG:
LOG_LEVEL=debug stowsh
EOF

. "${CURRENT_DIR}/.logging";
. "${CURRENT_DIR}/.stowsh-install";

call_git() {
  local staging_dir

  if [ -f "${CONFIG_PATH}/staging_dir" ]; then
    log_debug "using staging_dir ${staging_dir}";
    staging_dir="$(cat $CONFIG_PATH/staging_dir)";
  else
    log_error "no staging_dir file at ${CONFIG_PATH}/staging_dir";
    exit 1;
  fi

  if [ -d "${staging_dir}/git/dotfiles" ]; then
    log_debug "found dotfiles at ${staging_dir}/git/dotfiles";
  else 
    log_error "no dotfiles at ${staging_dir}/git/dotfiles";
    exit 1;
  fi

  local git_path;
  git_path="$(which git)";

  log_debug "passing args to ${git_path} in your dotfiles folder";

  cd "${staging_dir}/git/dotfiles";
  
  "${git_path}" "$@";
}

main() {
  log_debug "validating required variables";

  if [ ! -d "${HOME}" ]; then
    log-error "HOME, ${HOME}, does not exist";
    exit 1;
  fi

  if [ ! -d "${DOTFILES_DEPLOY_DIR}" ]; then
    log_error "DOTFILES_DEPLOY_DIR, ${DOTFILES_DEPLOY_DIR}, does not exist";
    exit 1;
  fi

  local subcommand=$1;
  shift;

  case "${subcommand}" in
    'install')
      install "$@";
      ;;
    'git')
      call_git "$@";
      ;;
    '-h' | '--help')
      echo "${STOWSH_USAGE}";
      exit 0;
      ;;
    *)
      log_error "invalid subcommand, ${subcommand}";
      exit 1;
      ;;
  esac
}

main "$@";
